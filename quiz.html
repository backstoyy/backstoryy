<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BackStoryy - Quiz</title>

    <!-- Icon -->
    <link rel="icon" type="image/svg+xml" href="backstoryy.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --brand-color: #115e59; /* teal-800 */
            --preloader-bg: #134e4a;
            --preloader-text: #ffffff;
            --preloader-neuron: #a7f3d0;
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --brand-color: #2dd4bf; /* teal-400 */
            --preloader-bg: #111827;
            --preloader-text: #f9fafb;
            --preloader-neuron: #2dd4bf;
        }

        .font-title {
            font-family: 'Playfair Display', serif;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            transition: background-color 0.4s, color 0.4s;
            overflow-x: hidden;
        }

        /* Themed elements */
        .themed-container { background-color: var(--bg-secondary); }
        .themed-header { color: var(--brand-color); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-border { border-color: var(--border-color); }
        .themed-welcome-card { background-color: var(--bg-tertiary); }
        .themed-question-card { background-color: var(--bg-secondary); }
        
        .dark .themed-question-card {
            border: 1px solid var(--border-color);
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.1);
        }

        .themed-option-label { 
            display: block;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            background-color: var(--bg-primary);
        }
        .themed-option-label:hover {
            border-color: #14b8a6;
            background-color: #ccfbf11a; /* Teal-100 with low opacity for dark mode compatibility */
        }
        .dark .themed-option-label:hover {
            background-color: #2dd4bf1a; /* Teal-400 with low opacity */
        }

        /* --- PRELOADER STYLES --- */
        #preloader {
            background-color: var(--preloader-bg);
            transition: opacity 0.7s ease-in-out;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .neuron-svg circle, .neuron-svg line {
            fill: var(--preloader-neuron);
            stroke: var(--preloader-neuron);
        }
        .loading-text {
            color: var(--preloader-text);
        }
        #preloader.hidden { opacity: 0; pointer-events: none; }
        .neuron-svg { 
            width: 150px;
            height: 150px;
            animation: pulse 2s infinite ease-in-out; 
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .loading-text { animation: fadeInUp 1s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* --- END PRELOADER --- */

        #quiz-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 440px;
            margin: 2rem auto;
            overflow: visible;
        }
        .question-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem 2.5rem;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s ease-in-out, border 0.4s, box-shadow 0.4s;
            will-change: transform, opacity;
            cursor: grab;
            overflow: hidden;
            border-radius: 24px;
        }
        
        /* --- QUIZ ANIMATIONS --- */
        @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-from-bottom { animation: slideInFromBottom 0.6s ease-out forwards; }
        .dismiss-right { transform: translateX(150%) rotate(15deg) !important; opacity: 0 !important; }
        .animate-crossfade-out { opacity: 0 !important; transition: opacity 0.5s ease-in-out; }
        .animate-crossfade-in { opacity: 1 !important; transition: opacity 0.5s ease-in-out; transition-delay: 0.2s; }
        /* --- END QUIZ ANIMATIONS --- */

        .option-input { display: none; }
        .option-input:checked + .themed-option-label { border-color: #0d9488; background-color: #ccfbf1; font-weight: 600; color: #134e4a; }
        .dark .option-input:checked + .themed-option-label { background-color: #2dd4bf; border-color: #5eead4; color: #115e59; }
        
        .themed-option-label.correct { border-color: #22c55e !important; background-color: #dcfce7 !important; color: #15803d !important; font-weight: 700; }
        .dark .themed-option-label.correct { background-color: #22c55e !important; color: #f0fdf4 !important; }
        
        .themed-option-label.incorrect { border-color: #ef4444 !important; background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: 700; }
        .dark .themed-option-label.incorrect { background-color: #ef4444 !important; color: #fef2f2 !important; }

        .answered .options-container { pointer-events: none; }
        
        /* Dark Mode Toggle Styles */
        #theme-toggle-btn .sun-icon { display: none; }
        .dark #theme-toggle-btn .sun-icon { display: block; }
        .dark #theme-toggle-btn .moon-icon { display: none; }

        @media (max-width: 700px) {
            #quiz-container { max-width: 100%; height: auto; margin-top: 1rem; margin-bottom: 1rem; }
            .question-card { padding: 1.5rem 1rem; min-height: auto; }
            .themed-container { margin-top: 0; margin-bottom: 0; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="text-center">
            <svg class="neuron-svg mx-auto" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <circle cx="50" cy="50" r="15" filter="url(#glow)"/>
                <line x1="50" y1="50" x2="20" y2="20" stroke-width="2"/>
                <line x1="50" y1="50" x2="80" y2="20" stroke-width="2"/>
                <line x1="50" y1="50" x2="20" y2="80" stroke-width="2"/>
                <line x1="50" y1="50" x2="80" y2="80" stroke-width="2"/>
                <line x1="50" y1="50" x2="50" y2="10" stroke-width="2"/>
                <line x1="50" y1="50" x2="50" y2="90" stroke-width="2"/>
                <line x1="50" y1="50" x2="10" y2="50" stroke-width="2"/>
                <line x1="50" y1="50" x2="90" y2="50" stroke-width="2"/>
            </svg>
            <h2 class="loading-text text-2xl font-bold text-white mt-4">Time To Benchmark Your Knowledge Portfolio.</h2>
        </div>
    </div>

    <div id="page-content" class="themed-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 shadow-xl rounded-2xl my-8 opacity-0 transition-opacity duration-500">
        <header class="text-center mb-8 md:mb-12 themed-border border-b pb-6 w-full relative">
            <a href="index.html" class="font-title text-5xl md:text-6xl font-bold themed-header no-underline hover:opacity-80 transition">BackStoryy</a>
            <p class="mt-2 text-lg themed-text-secondary">A Collection of Curated Articles & Quizzes</p>
            <div class="absolute top-0 right-0">
                <button id="theme-toggle-btn" class="p-2 rounded-full themed-text-secondary hover:bg-gray-500/10" aria-label="Toggle theme">
                    <i data-lucide="moon" class="moon-icon"></i>
                    <i data-lucide="sun" class="sun-icon"></i>
                </button>
            </div>
        </header>

        <main id="main-content" class="w-full">
            <div id="welcome-screen" class="text-center">
                <div class="themed-welcome-card p-8 rounded-xl shadow-inner relative">
                    <a href="index.html" class="absolute top-4 left-4 themed-header hover:opacity-80 transition-colors" aria-label="Back to Home">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </a>
                    <h2 class="text-3xl font-bold themed-header mb-4">Weekly Quiz</h2>
                    <p class="themed-text-secondary mb-6">Test your knowledge of the latest events. Click the button below to begin.</p>
                    <button id="start-btn" class="inline-block px-8 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105">
                        Start Quiz
                    </button>
                </div>
            </div>
            <div id="quiz-wrapper" class="hidden">
                <div id="quiz-container">
                    <div id="loading-indicator" class="flex items-center justify-center h-full">
                        <p class="text-lg themed-text-secondary">Loading Quiz...</p>
                    </div>
                </div>
                <div id="end-quiz-container" class="text-center mt-4 hidden">
                    <a href="index.html" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 no-underline">End Quiz</a>
                </div>
            </div>
        </main>

        <footer class="text-center pt-8 mt-8 themed-border border-t themed-text-secondary">
            <p>&copy; 2025 BackStoryy. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // --- PRELOADER SCRIPT ---
        window.addEventListener('load', () => {
            const preloader = document.getElementById('preloader');
            const pageContent = document.getElementById('page-content');
            setTimeout(() => {
                preloader.classList.add('hidden');
                pageContent.classList.remove('opacity-0');
                preloader.addEventListener('transitionend', () => { preloader.style.display = 'none'; });
            }, 2400);
        });

        // --- MAIN QUIZ SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeScreen = document.getElementById('welcome-screen');
            const quizWrapper = document.getElementById('quiz-wrapper');
            const startBtn = document.getElementById('start-btn');
            const quizContainer = document.getElementById('quiz-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const endQuizContainer = document.getElementById('end-quiz-container');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const LS_KEY = 'backstoryy_quiz_attempt_v1';
            let quizData = [];
            let currentQuestionIndex = 0;
            let score = 0;
            let answerSelected = false;

            // --- THEME LOGIC ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                localStorage.setItem('theme', theme);
                lucide.createIcons(); // Re-render icons after theme change
            };

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(currentTheme);
            });

            // Apply saved theme on initial load
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            // --- END THEME LOGIC ---

            startBtn.addEventListener('click', () => {
                welcomeScreen.classList.add('hidden');
                quizWrapper.classList.remove('hidden');
                quizWrapper.classList.add('animate-slide-in-from-bottom');
                initializeQuiz();
            });

            function getStoredQuizAttempt() {
                const data = localStorage.getItem(LS_KEY);
                if (!data) return { attempted: false };
                try {
                    const parsed = JSON.parse(data);
                    if (!parsed.timestamp || typeof parsed.score !== 'number') return { attempted: false };
                    // ‚≠ê Limit the attempt to 10 minutes
                    if (Date.now() - parsed.timestamp < 600000) {
                        return { attempted: true, score: parsed.score };
                    }
                    return { attempted: false };
                } catch { return { attempted: false }; }
            }

            function storeQuizAttempt(finalScore) {
                localStorage.setItem(LS_KEY, JSON.stringify({ score: finalScore, timestamp: Date.now() }));
            }

            async function showStoredResult(storedScore) {
                quizWrapper.classList.remove('hidden');
                welcomeScreen.classList.add('hidden');
                
                // Fetch questions just to get the total count for display
                const response = await fetch('questions.json');
                const questions = await response.json();
                const totalQuestions = questions.length;

                quizContainer.innerHTML = `
                    <div class="themed-question-card question-card" style="position:relative; transform:none; opacity:1; z-index:1;">
                        <div class="flex flex-col items-center justify-center h-full text-center">
                            <h2 class="text-3xl font-bold themed-header mb-4">Quiz Already Completed!</h2>
                            <p class="text-xl themed-text-secondary">Your last score was:</p>
                            <p class="text-6xl font-extrabold text-teal-600 my-4">${storedScore} / ${totalQuestions}</p>
                            <p class="mt-4 themed-text-secondary text-base">You can try again after 10 minutes.</p>
                            <a href="index.html" class="mt-6 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 no-underline">Back to Home</a>
                        </div>
                    </div>`;
            }

            async function initializeQuiz() {
                const storedAttempt = getStoredQuizAttempt();
                if (storedAttempt.attempted) {
                    showStoredResult(storedAttempt.score);
                    return;
                }
                
                loadingIndicator.style.display = 'flex';
                quizContainer.innerHTML = '';
                quizContainer.appendChild(loadingIndicator);

                try {
                    if (quizData.length === 0) {
                        const response = await fetch('questions.json');
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        quizData = await response.json();
                    }
                    currentQuestionIndex = 0; score = 0; answerSelected = false;
                    loadingIndicator.style.display = 'none';
                    createAllCards();
                    updateCardStack();
                    setupCardEventListeners();
                    endQuizContainer.classList.remove('hidden');
                } catch (error) {
                    console.error("Failed to load quiz:", error);
                    loadingIndicator.style.display = 'none';
                    quizContainer.innerHTML = `<p class="text-red-500 text-center font-semibold">Failed to load the quiz. Please make sure 'questions.json' is available.</p>`;
                }
            }

            function createAllCards() {
                quizContainer.innerHTML = '';
                const quizDataWithResult = [...quizData, { isResultCard: true }];
                quizDataWithResult.forEach((data, index) => {
                    const card = createQuestionCard(data, index, quizData.length);
                    quizContainer.appendChild(card);
                });
            }

            function createQuestionCard(data, index, totalQuestions) {
                const card = document.createElement('div');
                card.classList.add('themed-question-card', 'question-card');
                card.dataset.index = index;
                if (data.isResultCard) {
                    card.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center">
                            <h2 class="text-3xl font-bold themed-header mb-4">Quiz Complete!</h2>
                            <p class="text-xl themed-text-secondary">You scored:</p>
                            <p class="text-6xl font-extrabold text-teal-600 my-4" id="final-score">0 / ${totalQuestions}</p>
                            <a href="index.html" class="mt-6 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 no-underline">Back to Home</a>
                        </div>`;
                } else {
                    const optionsHtml = data.options.map((option, i) => `
                        <div>
                            <input type="radio" class="option-input" name="question-${index}" id="option-${index}-${i}" value="${option}">
                            <label for="option-${index}-${i}" class="themed-option-label">${option}</label>
                        </div>`).join('');
                    card.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-lg font-semibold text-teal-600 mb-2 text-center">Question ${index + 1} of ${totalQuestions}</p>
                            <h2 class="text-2xl font-bold mb-6 text-center">${data.question}</h2>
                            <div class="options-container">${optionsHtml}</div>
                        </div>`;
                }
                return card;
            }
            
            function setupCardEventListeners() {
                const currentCard = getCurrentCard();
                if (!currentCard) return;
                const optionsContainer = currentCard.querySelector('.options-container');
                if (optionsContainer) {
                    optionsContainer.addEventListener('change', handleOptionSelect);
                }
            }

            function updateCardStack() {
                const cards = quizContainer.querySelectorAll('.question-card');
                cards.forEach((card, index) => {
                    const relativeIndex = index - currentQuestionIndex;
                    if (relativeIndex >= 0) {
                        card.style.transform = `scale(${1 - (relativeIndex * 0.05)}) translateY(-${relativeIndex * 15}px)`;
                        card.style.opacity = `${1 - (relativeIndex * 0.1)}`;
                        card.style.zIndex = cards.length - index;
                        card.classList.remove('dismiss-right');
                    }
                });
            }

            function handleOptionSelect(e) {
                endQuizContainer.classList.add('hidden');
                if (answerSelected) return;
                answerSelected = true;
                const selectedInput = e.target;
                const selectedLabel = selectedInput.nextElementSibling;
                const questionData = quizData[currentQuestionIndex];
                const selectedOptionLetter = selectedInput.value.split(')')[0].trim();
                const isCorrect = selectedOptionLetter === questionData.answer;
                
                handleAnswerFeedback(isCorrect, selectedLabel, questionData.answer);

                if (currentQuestionIndex === quizData.length - 1) {
                    setTimeout(showFinalResultWithCrossfade, 1200);
                } else {
                    setTimeout(nextQuestion, 1200);
                }
            }

            function handleAnswerFeedback(isCorrect, selectedLabel, correctLetter) {
                const currentCard = getCurrentCard();
                currentCard.classList.add('answered');
                if (isCorrect) {
                    score++;
                    selectedLabel.classList.add('correct');
                } else {
                    selectedLabel.classList.add('incorrect');
                }
                const optionInputs = currentCard.querySelectorAll('.option-input');
                optionInputs.forEach(input => {
                    const optionLetter = input.value.split(')')[0].trim();
                    if (optionLetter === correctLetter) {
                        input.nextElementSibling.classList.add('correct');
                    }
                });
            }

            function nextQuestion() {
                if (currentQuestionIndex >= quizData.length -1) return;
                const card = getCurrentCard();
                if (card) card.classList.add('dismiss-right');
                currentQuestionIndex++;
                answerSelected = false;
                setTimeout(() => {
                    updateCardStack();
                    setupCardEventListeners();
                }, 100);
            }
            
            function showFinalResultWithCrossfade() {
                const lastQuestionCard = getCurrentCard();
                const resultCard = quizContainer.querySelector(`[data-index="${quizData.length}"]`);

                if (lastQuestionCard) {
                    lastQuestionCard.classList.add('animate-crossfade-out');
                }
                if (resultCard) {
                    document.getElementById('final-score').innerText = `${score} / ${quizData.length}`;
                    storeQuizAttempt(score);
                    resultCard.style.zIndex = 50;
                    resultCard.classList.add('animate-crossfade-in');
                }
            }

            function getCurrentCard() {
                return quizContainer.querySelector(`[data-index="${currentQuestionIndex}"]`);
            }
        });
    </script>
</body>
</html>
